# Express+Mongodb åŠ¨æ€æ³¨å…¥ mongodb å¯†ç å®è·µè®°å½•

:::info åˆè¡·
ç®€å•ä»‹ç»ä¸‹å¦‚ä½•åœ¨ `express` é¡¹ç›®ä¸‹é…åˆ `docker-compose` åŠ¨æ€æ³¨å…¥ `mongodb` è´¦å·å¯†ç ï¼Œé¡¹ç›®ç›®å½•åœ¨ä¸‹æ–¹ï¼Œä½†ä¸æ¶‰åŠå…·ä½“é¡¹ç›®å¦‚ä½•è¿è¡Œï¼Œåªä»‹ç»å¦‚ä½•ä½¿ç”¨ã€‚
:::

## é¡¹ç›®ç›®å½•

```
ğŸ“¦backend
 â”£ ğŸ“‚db
 â”ƒ â”— ğŸ“œindex.ts
 â”£ ğŸ“‚interface
 â”£ ğŸ“‚middleware
 â”£ ğŸ“‚models
 â”£ ğŸ“‚routes
 â”£ ğŸ“‚utils
 â”£ ğŸ“œ.dockerignore
 â”£ ğŸ“œ.eslintrc.js
 â”£ ğŸ“œ.gitignore
 â”£ ğŸ“œDockerfile 
 â”£ ğŸ“œREADME.md
 â”£ ğŸ“œapp.ts
 â”£ ğŸ“œbuild.sh // æ³¨å…¥ mongodb å¯†ç å’Œå•ä¸ªåº“å¯†ç 
 â”£ ğŸ“œdev.env // å¼€å‘ç¯å¢ƒå˜é‡
 â”£ ğŸ“œdocker-compose.yml // ç”Ÿæˆé¡¹ç›®å’Œ mongodb é•œåƒ
 â”£ ğŸ“œmongo-init.sh // åˆå§‹åŒ–è´¦å·å¯†ç 
 â”£ ğŸ“œpackage-lock.json 
 â”£ ğŸ“œpackage.json
 â”£ ğŸ“œprod.env // ç”Ÿäº§ç¯å¢ƒå˜é‡
 â”— ğŸ“œtsconfig.json
```

## ç¯å¢ƒæ–‡ä»¶

### dev.env

```ini
NODE_ENV=dev
PORT=3981

# MONGODB_URL=mongodb://localhost:27017/auto-answer
MONGODB_URL=mongodb://mongodb:27017/auto-answer

MONGO_INITDB_ROOT_USERNAME=root
MONGO_INITDB_ROOT_PASSWORD=123456
MONGO_USERNAME=admin
MONGO_PASSWORD=test123456
MONGO_HOST=localhost
MONGO_PORT=27017
MONGO_INITDB_DATABASE=auto-answer
```

### prod.env

```ini
NODE_ENV=production
PORT=3981

# MONGODB_URL=mongodb://localhost:27017/auto-answer
MONGODB_URL=mongodb://mongodb:27017/auto-answer

MONGO_INITDB_ROOT_USERNAME=root
MONGO_INITDB_ROOT_PASSWORD=123456
MONGO_USERNAME=admin
MONGO_PASSWORD=test123456
MONGO_HOST=mongodb
MONGO_PORT=27017
MONGO_INITDB_DATABASE=auto-answer
```

## æ„å»ºè¿è¡Œ compose è„šæœ¬ build.sh

````sh
#!/bin/bash

if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]
then
  echo "Need input with build env('prod' or 'dev') or MONGO_INITDB_ROOT_PASSWORD or MONGO_PASSWORD!"
  exit 1
else 
  echo $1
  echo $2
  echo $3
  env MACHINE_ENV=$1 MONGO_INITDB_ROOT_PASSWORD=$2 MONGO_PASSWORD=$3 docker-compose -p auto-answer-backend-hub up -d 
fi

# é€šè¿‡ sh build.sh ä¼ å‚æ•°
````

æ„å»º compose åªéœ€è¦è¿è¡Œä¸‹æ–¹å‘½ä»¤å³å¯ï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„å‘½ä»¤éœ€è¦åœ¨ `dockerfile` å’Œ `compose` æ„å»ºå®Œæˆä¹‹åè¿è¡Œï¼‰

```sh
sh build.sh MACHINE_ENV MONGO_INITDB_ROOT_PASSWORD MONGO_PASSWORD
```

å°†ä¸Šè¿° `MONGO_INITDB_ROOT_PASSWORD`ã€`MONGO_PASSWORD` æ›¿æ¢æˆä½ æ‰€æœ‰éœ€è¦çš„å¯†ç 

`MACHINE_ENV` ä¸ºä¸Šé¢é¡¹ç›®ç›®å½•ä¸­çš„ `dev` æˆ– `prod`ï¼Œå¯æ ¹æ®éœ€æ±‚æ›´æ”¹ã€‚

## æ„å»º Dockerfile

```docker
FROM node:16.0.0
LABEL maintainer="webB1anyaoyao@gmail.com"
COPY . /app
WORKDIR /app
RUN npm install
RUN ls
RUN npm run build
EXPOSE 3981
CMD [ "npm", "start"]
```

## æ„å»º docker-compose.yml

```yaml
version: "3"
services:
  app:
    container_name: auto-answer-backend-hub
    restart: on-failure
    env_file:
      - ${MACHINE_ENV}.env
    environment:
      - NODE_ENV=${MACHINE_ENV}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
    build: ./
    ports:
      - "3981:3981"
    # volumes:
    #   - .:/app
    depends_on:
      - mongodb
  mongodb:
    container_name: auto-answer-mongo-hub
    image: mongo:4.0.8
    env_file:
      - ${MACHINE_ENV}.env
    environment:
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
    volumes: 
      - ~/data:/data/db
      - ./mongo-init.sh:/docker-entrypoint-initdb.d/mongo-init.sh:ro
    ports:
      - "27017:27017"
```

- `env_file`ï¼šä¸ºç¯å¢ƒå˜é‡æ–‡ä»¶ï¼Œ`${MACHINE_ENV}.env` çš„ `MACHINE_EN` ä¸ºè¿è¡Œ `build.sh` æ³¨å…¥çš„å˜é‡
- `environment`ï¼š ç¯å¢ƒå˜é‡å¦‚æœå’Œ `env_file` ç›¸åŒï¼Œå°†ä¼šè¦†ç›– `env_file` ä¸­å˜é‡ï¼Œä¸Šè¿° `docker-compose.yml` ä¸­é€šè¿‡è¿è¡Œ `build.sh` æ³¨å…¥çš„å˜é‡è¦†ç›–äº† `MONGO_INITDB_ROOT_PASSWORD` å’Œ `MONGO_PASSWORD` å¯ä»¥è®©æ•°æ®åº“å¯†ç å˜æˆåŠ¨æ€çš„

## `mongo-init.sh` ç”Ÿæˆ mongodb è„šæœ¬

```sh
mongo -- "$MONGO_INITDB_DATABASE" <<EOF
  db.createUser({
    user: "$MONGO_USERNAME",
    pwd: "$MONGO_PASSWORD",
    roles: [
      { role: "readWrite", db: "$MONGO_INITDB_DATABASE" }
    ]
  })
EOF
```

## æ•°æ®è¿æ¥

æ–‡ä»¶ä½ç½®`./db/index.ts`

```typescript
import mongoose from 'mongoose'

const {
  MONGO_USERNAME = 'admin',
  MONGO_PASSWORD = 'test123456',
  MONGO_HOST = 'localhost',
  MONGO_PORT = '27017',
  MONGO_INITDB_DATABASE = 'auto-answer'
} = process.env

let uri = ''
// é€šè¿‡ç¯å¢ƒå˜é‡åˆ¤æ–­ï¼Œåˆ‡æ¢è¿æ¥ mongodb çš„ uri
if (process.env.NODE_ENV === 'dev' || !process.env.NODE_ENV) {
  uri = `mongodb://${MONGO_HOST}:${MONGO_PORT}/${MONGO_INITDB_DATABASE}`
} else {
  uri = `mongodb://${MONGO_USERNAME}:${encodeURIComponent(MONGO_PASSWORD)}@${MONGO_HOST}:${MONGO_PORT}/${MONGO_INITDB_DATABASE}`
}

console.log(uri)

// mongodb://admin:test123456@localhost:27017/auto-answer
mongoose.connect(uri, {
  // authSource: 'admin'
}, () => {
  console.log('connect!')
})

const db = mongoose.connection

db.once('open', () => {
  console.log('db is connect!')
})

db.on('error', error => {
  console.log(error)
})

db.on('close', () => {
  console.log('db is closed!')
})

export default mongoose

```

## éªŒè¯

å®Œæˆä¸Šé¢çš„æ­¥éª¤åŸºæœ¬ä¸Šå°±èƒ½é€šè¿‡ `compose` è¿è¡Œåç«¯çš„é¡¹ç›®äº†ï¼Œåœ¨é¡¹ç›®ç›®å½•é€šè¿‡å‘½ä»¤ï¼š

```sh
sh build.sh MACHINE_ENV MONGO_INITDB_ROOT_PASSWORD MONGO_PASSWORD
```

å°±ä¼šè¿è¡Œ `compose` ç”Ÿæˆä¸¤ä¸ªå®¹å™¨ï¼š

- auto-answer-backend-hubï¼šåç«¯æœåŠ¡
- auto-answer-mongo-hubï¼šæ•°æ®åº“æœåŠ¡

é€šè¿‡ `docker` å‘½ä»¤è¿›å…¥åˆ° `mongodb` å®¹å™¨ï¼š

```sh
docker exec -it auto-answer-mongo-hub /bin/base
```

è¿›å…¥åï¼Œè¾“å…¥ `mongo` è¿›å…¥ `mongo`ï¼š

```sh
mongo
```

è¿™æ—¶å€™è¾“å…¥ `show dbs`ï¼Œå› ä¸ºæˆ‘ä»¬å¼€å¯äº†æ•°æ®åº“æƒé™æ˜¯çœ‹ä¸åˆ°æ•°æ®çš„

### éªŒè¯ root ç”¨æˆ·

- è¿›å…¥ `admin`

```sh
> use admin
switched to db admin
```

- ä½¿ç”¨ `db.auth`

```sh
db.auth('root', MONGO_INITDB_ROOT_PASSWORD)
```

ä¸Šé¢çš„ `root` ä¸ºç¯å¢ƒæ–‡ä»¶ä¸­çš„ `MONGO_INITDB_ROOT_USERNAME`ï¼Œ`MONGO_INITDB_ROOT_PASSWORD` ä¸ºè¿è¡Œ `sh` è„šæœ¬æ˜¯æ³¨å…¥çš„å¯†ç ï¼ˆè¿™é‡Œéœ€è¦æ›´æ¢æˆè‡ªå·±çš„å¯†ç ï¼‰ã€‚

å¦‚æœå¯†ç è´¦å·å’Œå¯†ç æ­£ç¡®çš„è¯ä¼šå‡ºç°ä»¥ä¸‹æç¤ºï¼š

```sh
> db.auth('root', MONGO_INITDB_ROOT_PASSWORD)
1
```

è¿™æ—¶å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“

```sh
> show dbs
admin        0.000GB
auto-answer  0.000GB
config       0.000GB
local        0.000GB
```

### éªŒè¯å·¥ä½œåº“

æˆ‘ä»¬åœ¨`mongo-init.sh`ä¸­é€šè¿‡ï¼š

```sh
db.createUser({
    user: "$MONGO_USERNAME",
    pwd: "$MONGO_PASSWORD",
    roles: [
      { role: "readWrite", db: "$MONGO_INITDB_DATABASE" }
    ]
 })
```

ç”Ÿæˆäº†`MONGO_INITDB_DATABASE`ï¼Œè€Œè¿™é‡Œçš„`MONGO_INITDB_DATABASE`å°±æ˜¯æˆ‘ä»¬ç¯å¢ƒå˜é‡ä¸­è®¾ç½®çš„`auto-answer`

ç„¶åæˆ‘ä»¬é€€å‡º `mongo` åé‡æ–°è¿›å…¥ `auto-answer`ï¼š

```sh
> exit
bye
root@a25acd1cd787:/# mongo
MongoDB shell version v4.0.8
connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("1179501c-6e50-433b-90dc-db828be7c467") }
MongoDB server version: 4.0.8
> show dbs
> use auto-answer
switched to db auto-answer
> show collections
Warning: unable to run listCollections, attempting to approximate collection names by parsing connectionStatus
```

è¿™æ—¶å¯ä»¥å‘ç° `auto-answer` ä¸‹æ²¡æœ‰ä»»ä½•è¡¨ï¼Œä¸‹ä¸€æ­¥è¿›è¡Œ `db.auth`

```sh
> db.auth(MONGO_USERNAME, MONGO_PASSWORD)
1
> show dbs
auto-answer  0.000GB
> show collections
airs
cookers
```

ä¸Šé¢çš„ `MONGO_USERNAME` æ˜¯ç¯å¢ƒå˜é‡ä¸­çš„ç”¨æˆ·åï¼ˆéœ€æ›¿æ¢æˆè‡ªå·±çš„ï¼‰ï¼Œ`MONGO_PASSWORD` æ˜¯é€šè¿‡ `sh` æ³¨å…¥çš„ç”Ÿæˆç”¨æˆ·çš„å¯†ç ã€‚

è‡³æ­¤å®Œæˆæ‰€æœ‰æ“ä½œã€‚

